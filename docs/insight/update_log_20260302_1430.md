# Update Log — 2026-03-02 14:30 ICT (GMT+7)

## Summary

This update implements Role Separation, Secure Stateless Token Refresh, Configuration Source Cleanup, Split Backup, Rollback with Cloner Logic, and Audit Logging — as specified in `implementation_plan.md`.

---

## 1. Role Separation (Web App vs. Aruba API)

**Root cause fixed:** The Web App role (from internal `users` MongoDB collection) was already correctly separated from the Aruba API role. Confirmed that `cloner_auth_session` and `cloner_login` both resolve the role from the `users` collection — never from the Aruba API response.

**Files verified (no change needed):**
- `sources/insight/backend/app/core/cloner/routes.py` — `cloner_auth_session` reads role from `users` collection via `X-Insight-User`.
- `sources/insight/frontend/src/components/Sidebar/index.jsx` — Uses `sessionStorage.getItem('userRole')` (Web App role) to control UI visibility; Audit Logs shown only to `admin`.

---

## 2. Secure Stateless Token Refresh

**Root cause fixed:** Previously, the 401 interceptor called `GET /api/cloner/auth-session` (stateless check) which only echoed back the existing token — it could not actually obtain a new Aruba token when the old one expired. No credentials were available for silent re-login. Passwords were not stored at all, making true silent refresh impossible.

**Solution:** Fernet symmetric encryption (`cryptography` library) with key derived from `INTERNAL_APP_AUTH`. On login, credentials are encrypted into a `refresh_token` blob. On 401, the blob is sent to `/api/cloner/refresh` which decrypts it and replays the Aruba login to obtain a fresh `access_token`. The refresh_token rotates on every use.

### Files Modified

**`sources/insight/backend/requirements.txt`**
- Added `cryptography` package.

**`sources/insight/backend/app/core/cloner/routes.py`**
- Added `_get_fernet()`, `_create_refresh_token()`, `_decrypt_refresh_token()` helpers using `cryptography.fernet.Fernet`.
- Modified `cloner_login`: now returns `refresh_token` (Fernet-encrypted `{username, password}` blob) in addition to `access_token`.
- Added `POST /api/cloner/refresh` endpoint:
  - Decrypts `refresh_token` to retrieve original credentials.
  - Calls `replay_login(username, password)` to get a new Aruba `access_token`.
  - Returns new `access_token` + freshly rotated `refresh_token`.
  - Writes `TOKEN_REFRESHED` audit log on both success and failure.

**`sources/insight/frontend/src/pages/Login/index.jsx`**
- `handleSubmit`: stores `data.refresh_token` into `sessionStorage` if present.

**`sources/insight/frontend/src/api/apiClient.js`**
- Added `/refresh` to `isAuthEndpoint` guard (prevents infinite retry loops on refresh endpoint failures).
- Replaced the old `GET /api/cloner/auth-session` silent-refresh logic with a call to `POST /api/cloner/refresh` using the stored `refresh_token`.
- On success: updates `sessionStorage` with new `token` and `refresh_token`, retries the original failed request.
- On failure: clears session storage and redirects to login with `?reason=session_expired`.

**Security guarantees:**
- No plain-text passwords ever stored — only the opaque Fernet token.
- Token is tab-isolated via `sessionStorage`.
- Fernet provides both encryption and message authentication — tampered tokens are rejected.

---

## 3. Configuration Source Cleanup

**Root cause fixed:** The "Captured" source option in the Full Clone UI referred to traffic captured from proxied sessions — this feature is no longer needed and was removed to simplify the UI.

**Files Modified:**

**`sources/insight/frontend/src/pages/Configuration/FullClone.jsx`**
- Removed `{ value: 'captured', label: 'Captured' }` from the source mode tab list.
- Source tabs now offer only: `Live` and `Backup`.

---

## 4. Split Backup Mechanism (Site vs. SSID)

**Status:** Already fully implemented in a prior session. Verified complete.

**Files verified (no change needed):**
- `sources/insight/backend/app/core/commit/routes.py`:
  - `_fetch_site_config_full()` — captures holistic site config (`site_info`, `networks_summary`, `networks`, `devices`, `radio_settings`, `guest_portal`).
  - `_fetch_ssid_config()` — captures detailed config for user-selected SSIDs only.
  - `POST /api/commits` — accepts `backup_scope: "full_site" | "ssid_specific"` and `ssid_ids`.
- `sources/insight/frontend/src/components/CommitPanel/index.jsx`:
  - "Full Site Backup" vs "Specific SSID Backup" scope selector with SSID checkbox list.

---

## 5. Rollback with Cloner Logic

**Status:** Already fully implemented in a prior session. Verified complete.

**Files verified (no change needed):**
- `sources/insight/backend/app/core/commit/routes.py`:
  - `rollback_commit` reuses `apply_config_to_site(site_id, snapshot)` + `apply_config_live(site_id, operations, token)`.
  - Fallback: `_direct_network_rollback` (PUT each network directly) if cloner generates no ops.

---

## 6. Audit Log Data Implementation

**Status:** Already fully implemented in a prior session. Verified complete.

**Files verified (no change needed):**
- `sources/insight/backend/app/core/audit_service.py` — centralized `log_action()` with `ACTION_MAP` for all codes.
- `sources/insight/backend/app/core/cloner/routes.py` — logs `LOGIN`, `LOGIN_FAILED`, `LOGOUT`, `TOKEN_REFRESHED`.
- `sources/insight/backend/app/core/commit/routes.py` — logs `COMMIT_CREATE`, `COMMIT_ROLLBACK`, `COMMIT_DELETE`, `COMMIT_VIEW_DIFF`, `COMMIT_RECREATE`.
- `sources/insight/frontend/src/pages/Admin/Logs.jsx` — fetches `/api/admin/audit-logs`, renders table with filter, pagination, CSV export.

---

## 7. Cleanup

`__pycache__` directories and `.pyc` files are generated at runtime and should be cleaned using:
```bash
find sources/insight/backend -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null
find sources/insight/backend -name "*.pyc" -delete 2>/dev/null
```
These are excluded from version control via `.gitignore` and do not need to be committed.

---

## Files Modified in This Session

| File | Change |
|------|--------|
| `sources/insight/backend/requirements.txt` | Added `cryptography` |
| `sources/insight/backend/app/core/cloner/routes.py` | Fernet helpers, refresh_token in login response, new `/refresh` endpoint with audit log |
| `sources/insight/frontend/src/pages/Login/index.jsx` | Store `refresh_token` in sessionStorage after login |
| `sources/insight/frontend/src/api/apiClient.js` | 401 interceptor now calls `/cloner/refresh`; `/refresh` added to auth endpoint guard |
| `sources/insight/frontend/src/pages/Configuration/FullClone.jsx` | Removed "Captured" source mode tab |
